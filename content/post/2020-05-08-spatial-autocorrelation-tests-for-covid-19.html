---
title: Finding COVID-19 Clusters Using R
author: Dennis Sobolewski
date: '2020-05-08'
slug: spatial-autocorrelation-tests-for-covid-19
categories:
  - R
tags:
  - geospatial
  - sf
  - autocorrelation
subtitle: ''
summary: ''
authors: []
lastmod: '2020-05-08T15:23:52-05:00'
featured: no
image:
  caption: ''
  focal_point: ''
  preview_only: no
projects: []
---



<p>COVID-19 data analyses are all the rage at the moment, with COVID datasets being made publicly available at the city, state, and national level. It’s an awesome example of how open data can lead to a better understanding of the world around us. And, the best part is, much of the actual analysis is being done for free! I decided to take a stab it and contribute to the public COVID discorse with my own analysis below.</p>
<p>Talk about COVID-19 “hot spots” is frequent in the news, often referring to NYC since it has the most COVID-19 cases of any city in the US. Beyond looking at simple COVID case tallies, it is not clear how these hot spots are being determined. How do they determine that one area has a statistically significant higher number of cases than another? Factors such as population and the COVID rates of locations directly next to an area all affect how significance is determined within COVID case data. Enter Moran’s I, a measure of spatial autocorrelation that can be used to test for clustering, or dispersion, of an outcome on a map. I will show you how to perform and interpret a Moran’s I test by applying it to real COVID data for a selection of US cities.</p>
<div id="data-sources" class="section level2">
<h2>Data Sources</h2>
<p>For each area you want to test for spatial autocorrelation you will need three main pieces of information.</p>
<ol style="list-style-type: decimal">
<li>Total COVID cases</li>
<li>Estimated population</li>
<li>Geometry of the area</li>
</ol>
<div id="covid-cases" class="section level3">
<h3>COVID Cases</h3>
<p>The most granular datasets I could find for COVID data has cases tallied at the zipcode level for certain cities and states. <a href="https://dph.illinois.gov/covid19/covid19-statistics">Here</a> is an example for the state of Illinois. Unfortunately I did not find a central repository or API that allows you to easily retrieve this data for multiple areas. Instead it appears a city or state will release the data on only their own site, meaning I will need to aggregate the data from multiple sources. For this blog I manually downloaded COVID case data by zipcode for Philadelphia, Chicago, and San Francisco</p>
</div>
<div id="population-and-geometry" class="section level3">
<h3>Population and Geometry</h3>
<p>Finding population and case data was easy thanks to the publicly available Census API and the tidycensus R package. The <a href="https://www.census.gov/data/developers/guidance/api-user-guide.html">Census API</a> is pretty amazing, with thousands of different statistics available at multiple geographic levels. To make things easier, the <a href="https://github.com/walkerke/tidycensus">tidycensus</a> package is a convenient wrapper for this API that makes pulling data a breeze. Tidycensus can automatically pull the geometry of the area boundaries your statistics represent for easy plotting and analysis. Adding the geometry to the returned data converts it to an sf object that can be easily visualized using ggplot2. Here is all the code you need to create a heatmap of household income in the US by county.</p>
<pre class="r"><code>us_county_income &lt;- get_acs(geography = &quot;county&quot;, variables = &quot;B19013_001&quot;, 
                            shift_geo = TRUE, geometry = TRUE)

ggplot(us_county_income) + 
  geom_sf(aes(fill = estimate), color = NA) + 
  coord_sf(datum = NA) + 
  theme_minimal() + 
  scale_fill_viridis_c()</code></pre>
<p><img src="/post/2020-05-08-spatial-autocorrelation-tests-for-covid-19_files/figure-html/income-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>For our anaylsis I pulled the total population of each zipcode in the US, with its geometry, and did an inner join with my COVID datasets. I end up with a seperate sf object for Philadelpia, San Francisco, and Chicago.</p>
<pre class="r"><code>head(phila_covid_sf)</code></pre>
<pre><code>## Simple feature collection with 6 features and 4 fields
## geometry type:  MULTIPOLYGON
## dimension:      XY
## bbox:           xmin: 478510.5 ymin: 4419279 xmax: 496536.8 ymax: 4435730
## epsg (SRID):    26918
## proj4string:    +proj=utm +zone=18 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs
## # A tibble: 6 x 5
##   cases zip     pop                                  geometry cases_per_cap
##   &lt;dbl&gt; &lt;fct&gt; &lt;dbl&gt;                        &lt;MULTIPOLYGON [m]&gt;         &lt;dbl&gt;
## 1   403 19138 34614 (((485004.9 4433570, 485294.2 4433486, 4…         11.6 
## 2   171 19122 22690 (((486657.7 4426246, 486771.9 4426228, 4…          7.54
## 3   509 19149 59853 (((492066.7 4431838, 492275.7 4432106, 4…          8.50
## 4   627 19124 68905 (((489247.9 4429303, 489557.3 4429251, 4…          9.10
## 5   739 19143 65812 (((478510.5 4422474, 478711.6 4422840, 4…         11.2 
## 6   235 19130 26100 (((483562.3 4425076, 483487.3 4425183, 4…          9.00</code></pre>
</div>
</div>
<div id="morans-i" class="section level2">
<h2>Moran’s I</h2>
<p><img src="/home/dsobolew/Documents/personal-site/static/data/COVID_spatial/moran_I.png" style="display: block; margin: auto;" /></p>
</div>
<div id="philadelphia-example" class="section level2">
<h2>Philadelphia Example</h2>
<pre class="r"><code>phila_covid_sf %&gt;%
  ggplot() +
  geom_sf(aes(fill = cases_per_cap), color = NA) +
  coord_sf(datum = NA) +
  theme_minimal() +
  scale_fill_viridis_c(name = &quot;Cases Per 1000&quot;) +
  labs(title = &quot;Philadelphia COVID-19 Cases Per Capita&quot;)</code></pre>
<p><img src="/post/2020-05-08-spatial-autocorrelation-tests-for-covid-19_files/figure-html/phila_geo-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>library(spdep)

## Autocorrelation tests for phila
phila_sp &lt;- as(phila_covid_sf, &quot;Spatial&quot;)
phila_nb &lt;- poly2nb(phila_sp, queen = T, row.names = phila_sp$zip)
coords &lt;- coordinates(phila_sp)

plot(phila_sp)
plot(phila_nb, coords = coords, add = T, col = &quot;#F78764&quot;)</code></pre>
<p><img src="/post/2020-05-08-spatial-autocorrelation-tests-for-covid-19_files/figure-html/phila_queen-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>## EBI Morans I
set.seed(1988)
phila_moran_mc &lt;- EBImoran.mc(n = phila_sp$cases, 
                              x = phila_sp$pop, 
                              listw = nb2listw(phila_nb, style = &quot;W&quot;),
                              nsim = 9999)

phila_moran_mc</code></pre>
<pre><code>## 
##  Monte-Carlo simulation of Empirical Bayes Index (mean subtracted)
## 
## data:  cases: phila_sp$cases, risk population: phila_sp$pop
## weights: nb2listw(phila_nb, style = &quot;W&quot;)
## number of simulations + 1: 10000
## 
## statistic = 0.16173, observed rank = 9711, p-value = 0.0289
## alternative hypothesis: greater</code></pre>
<pre class="r"><code>plot(phila_moran_mc)</code></pre>
<p><img src="/post/2020-05-08-spatial-autocorrelation-tests-for-covid-19_files/figure-html/phila_mgl-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>phila_lc_moran &lt;- localmoran(phila_sp$cases_per_cap, 
                             listw = nb2listw(phila_nb, style = &quot;W&quot;), 
                             p.adjust.method = &quot;bonferroni&quot;,
                             alternative = &quot;two.sided&quot;)

phila_lc_moran_tidy &lt;- broom::tidy(phila_lc_moran) %&gt;%
  rename(p_value = 6 ,zip = .rownames, morans_i = 2, z_score = 5) %&gt;%
  select(zip, morans_i, z_score, p_value) %&gt;%
  mutate(morans_i = round(morans_i,3),
         z_score = round(z_score,3),
         p_value = round(p_value,3),
         lag_cases_per_cap = round(lag.listw(var = phila_sp$cases_per_cap, x =  nb2listw(phila_nb, style = &quot;W&quot;)),3),
         lag_mean = round(mean(lag.listw(var = phila_sp$cases_per_cap, x =  nb2listw(phila_nb, style = &quot;W&quot;))),3)
         )</code></pre>
<pre class="r"><code>head(phila_lc_moran_tidy)</code></pre>
<pre><code>## # A tibble: 6 x 6
##   zip   morans_i z_score p_value lag_cases_per_cap lag_mean
##   &lt;chr&gt;    &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;             &lt;dbl&gt;    &lt;dbl&gt;
## 1 19127    1.63    2.51    0.037              7.10     10.7
## 2 19137    0.969   1.86    0.254              8.50     10.7
## 3 19147    0.72    2.03    0.296              8.36     10.7
## 4 19123   -0.717  -2.08    0.303              7.88     10.7
## 5 19126    0.838   1.61    0.429             11.6      10.7
## 6 19138    0.282   0.752   1                 15.7      10.7</code></pre>
<p><img src="/post/2020-05-08-spatial-autocorrelation-tests-for-covid-19_files/figure-html/phila_mlc_plot-1.png" width="672" style="display: block; margin: auto;" /></p>
<p><img src="/post/2020-05-08-spatial-autocorrelation-tests-for-covid-19_files/figure-html/phila_mlc_plot_sf-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="functional-programming-to-test-many-locations" class="section level2">
<h2>Functional Programming to Test Many Locations</h2>
<p><img src="/post/2020-05-08-spatial-autocorrelation-tests-for-covid-19_files/figure-html/covid_plot-1.png" width="672" style="display: block; margin: auto;" /><img src="/post/2020-05-08-spatial-autocorrelation-tests-for-covid-19_files/figure-html/covid_plot-2.png" width="672" style="display: block; margin: auto;" /><img src="/post/2020-05-08-spatial-autocorrelation-tests-for-covid-19_files/figure-html/covid_plot-3.png" width="672" style="display: block; margin: auto;" /></p>
<p><img src="/post/2020-05-08-spatial-autocorrelation-tests-for-covid-19_files/figure-html/morans_gl-1.png" width="672" style="display: block; margin: auto;" /><img src="/post/2020-05-08-spatial-autocorrelation-tests-for-covid-19_files/figure-html/morans_gl-2.png" width="672" style="display: block; margin: auto;" /><img src="/post/2020-05-08-spatial-autocorrelation-tests-for-covid-19_files/figure-html/morans_gl-3.png" width="672" style="display: block; margin: auto;" /></p>
<p><img src="/post/2020-05-08-spatial-autocorrelation-tests-for-covid-19_files/figure-html/morans_local-1.png" width="672" style="display: block; margin: auto;" /><img src="/post/2020-05-08-spatial-autocorrelation-tests-for-covid-19_files/figure-html/morans_local-2.png" width="672" style="display: block; margin: auto;" /><img src="/post/2020-05-08-spatial-autocorrelation-tests-for-covid-19_files/figure-html/morans_local-3.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>##Functional Programming version


sf_plot &lt;- function(data, loc) {

data %&gt;%
  ggplot() +
  geom_sf(aes(fill = cases_per_cap)) +
  scale_fill_gradient(low = &quot;#FFF5F0&quot; , high = &quot;#A50F15&quot;, name = &quot;Cases Per 1000&quot;) +
  labs(title = paste0(loc,&quot; COVID-19 Cases by Zipcode&quot;))  

}

#function to create global moran density plots
global_morans_plot &lt;- function(data, loc){
  
  tibble::enframe(data$res) %&gt;%
    ggplot(aes(x = value)) +
    geom_line(stat = &quot;density&quot;) +
    geom_vline(xintercept = data$statistic, col = &quot;red&quot;) +
    annotate(geom = &quot;text&quot;,x = .25, y = 1.5, label = paste0(&quot;P-Value: &quot;,data$p.value)) +
    labs(title = paste0(&quot;Density Plot of Permutation Outcomes: &quot;,loc),
         subtitle = &quot;Monte-Carlo simulation of Empirical Bayes Index (mean subtracted)&quot;,
         x = &quot;Test Statistic&quot;, 
         y = &quot;Density&quot;)
  
}

#function to create tidy local morans tibble
local_morans_tidy &lt;- function(lm, sp, sf){
  
broom::tidy(lm) %&gt;%
    rename(p_value = 6 ,zip = .rownames, morans_i = 2, z_score = 5) %&gt;%
    inner_join(sf, by = c(&quot;zip&quot;=&quot;zip&quot;)) %&gt;%
    mutate(lag_cases_per_cap = spdep::lag.listw(var = sp$cases_per_cap, x = spdep::nb2listw(spdep::poly2nb(sp,queen = T))),
           lag_mean = mean(lag_cases_per_cap),
           cases_mean = mean(lag_cases_per_cap),
           quad = case_when(
             cases_per_cap &lt; cases_mean &amp; lag_cases_per_cap &lt; lag_mean ~ &quot;Low-Low&quot;,
             cases_per_cap &lt; cases_mean &amp; lag_cases_per_cap &gt;= lag_mean ~ &quot;Low-High&quot;,
             cases_per_cap &gt;= cases_mean &amp; lag_cases_per_cap &lt; lag_mean ~ &quot;High-Low&quot;,
             cases_per_cap &gt;= cases_mean &amp; lag_cases_per_cap &gt;= lag_mean ~ &quot;High-High&quot;
           ))

  
}


## Function to create local morans plots
local_morans_plots &lt;- function(lm_tidied, loc){
  
  ggplot() +
    geom_sf(data = sf::st_as_sf(lm_tidied)) +
    geom_sf(data = sf::st_as_sf(lm_tidied) %&gt;% filter(p_value &lt;= .1), aes(fill = quad)) +
    scale_fill_manual(values = c(&quot;Low-Low&quot;=&quot;#4DAF4A&quot; ,&quot;Low-High&quot;=&quot;#377EB8&quot;,&quot;High-Low&quot;=&quot;#FF7F00&quot;,&quot;High-High&quot;=&quot;#E41A1C&quot;)) +
    labs(title = paste0(loc,&quot; Significant COVID-19 Clustering&quot;), x = &quot;&quot;, y = &quot;&quot;, fill = &quot;&quot;)
  
  
}

#sombine sf objects into a tibble with nested lists
covid_tibble &lt;- tibble(
  location = c(&quot;San Francisco&quot;, &quot;Philadelphia&quot;,&quot;Chicago&quot;),
  covid_sf = list(sf_covid_sf,
                  phila_covid_sf, 
                  chi_covid_sf)
)


morans_results &lt;- covid_tibble %&gt;%
  ##perform global morans I calculation with MC simulations
  mutate(
    covid_map = map2(covid_sf,location,sf_plot),
    covid_sp = map(covid_sf, ~as(., &quot;Spatial&quot;)),    ##create sp object
    global_morans = map(covid_sp, ~ spdep::EBImoran.mc(n = .$cases,
                                                            x = .$pop,
                                                            listw = spdep::nb2listw(spdep::poly2nb(.,queen = T, row.names = .$zip)),
                                                            nsim = 9999)),     ##run global morans I test
    global_morans_tidied = map(global_morans, broom::tidy),    ##Create output plots
    global_moran_plots = map2(global_morans,location,global_morans_plot)) %&gt;%   #perform local morans I calculations
 ##Perform local morans I calculations
  mutate(
    local_morans = map(covid_sp, ~ spdep::localmoran(x = .$cases_per_cap,
                                                          listw = spdep::nb2listw(spdep::poly2nb(.,queen = T, row.names = .$zip)),
                                                          p.adjust.method = &quot;bonferroni&quot;)),    ##run local morans I 
    local_morans_tidied = pmap(list(local_morans, covid_sp, covid_sf), local_morans_tidy),    ##tidy the local morans I output
    local_morans_plots = map2(local_morans_tidied,location,local_morans_plots)    ##Create output plots
         )</code></pre>
</div>
